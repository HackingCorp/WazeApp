version: '3.8'

services:
  mailserver:
    image: ghcr.io/docker-mailserver/docker-mailserver:latest
    container_name: wazeapp-mailserver
    hostname: mail.wazeapp.xyz
    domainname: wazeapp.xyz
    restart: always
    ports:
      - "3025:25"   # SMTP (using port 3025 externally to avoid conflict)
      - "3587:587"  # SMTP Submission (StartTLS) - using 3587 externally
      - "3465:465"  # SMTPS (SSL/TLS) - using 3465 externally
      - "3993:993"  # IMAPS - using 3993 externally
    volumes:
      - ./mailserver/mail-data:/var/mail
      - ./mailserver/mail-state:/var/mail-state
      - ./mailserver/mail-logs:/var/log/mail
      - ./mailserver/config:/tmp/docker-mailserver
      - /etc/localtime:/etc/localtime:ro
    environment:
      # General Settings
      - OVERRIDE_HOSTNAME=mail.wazeapp.xyz
      - DMS_DEBUG=0

      # SSL/TLS Settings (disabled for now, will configure Let's Encrypt later)
      - SSL_TYPE=
      # To enable SSL later: SSL_TYPE=letsencrypt or SSL_TYPE=manual

      # SMTP Settings
      - ENABLE_SMTP=1
      - SMTP_ONLY=0
      - PERMIT_DOCKER=network
      - ENABLE_SPAMASSASSIN=1
      - ENABLE_CLAMAV=1
      - ENABLE_FAIL2BAN=1
      - ENABLE_POSTGREY=0

      # Authentication
      - ENABLE_SASLAUTHD=0
      - ENABLE_OAUTH2=0

      # Dovecot Settings
      - ENABLE_IMAP=1
      - ENABLE_POP3=0

      # Postfix Settings
      - POSTFIX_MESSAGE_SIZE_LIMIT=52428800  # 50MB
      - POSTFIX_MAILBOX_SIZE_LIMIT=0         # Unlimited

      # Anti-Spam/Virus
      - SPAMASSASSIN_SPAM_TO_INBOX=1
      - MOVE_SPAM_TO_JUNK=1
      - ENABLE_AMAVIS=1

      # DKIM/DMARC/SPF
      - ENABLE_OPENDKIM=1
      - ENABLE_OPENDMARC=1
      - ENABLE_POLICYD_SPF=1

      # Log Level
      - LOG_LEVEL=info

      # Update Check
      - UPDATE_CHECK_INTERVAL=1d

    cap_add:
      - NET_ADMIN

    networks:
      - wazeapp-network
      - dokploy-network

  # Optional: Rainloop Webmail (lightweight alternative to Roundcube)
  webmail:
    image: hardware/rainloop:latest
    container_name: wazeapp-webmail
    restart: always
    ports:
      - "8888:8888"
    volumes:
      - ./mailserver/rainloop-data:/rainloop/data
    networks:
      - wazeapp-network
    depends_on:
      - mailserver

networks:
  wazeapp-network:
    driver: bridge
  dokploy-network:
    external: true
